<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãªã‚“ã§ã‚‚ã‚¿ãƒ«ã‚¿ãƒ«ãƒã‚­ãƒ³ã«ã™ã‚‹ã‚²ãƒ¼ãƒ </title>
    <link rel="icon" type="image/x-icon"
        href="https://raw.githubusercontent.com/taltalhobby/shiritori-game/refs/heads/main/images/92-tartarchicken-favicon-256px.ico">
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        /* å±±å¹è‰²ç³»ã‚«ãƒ©ãƒ¼ãƒ‘ãƒ¬ãƒƒãƒˆ */
        :root {
            --sky-light: #fff8e1;
            /* æ·¡ã„å±±å¹è‰² */
            --sky: #ffcc80;
            /* è–„ã„å±±å¹è‰² */
            --blue: #ffa726;
            /* å±±å¹è‰² */
            --blue-dark: #f57c00;
            /* æ¿ƒã„å±±å¹è‰² */
            --white: #ffffff;
            --gray-light: #fff3e0;
            --text-dark: #5d4037;
            /* èŒ¶ç³»ãƒ†ã‚­ã‚¹ãƒˆ */
            --text-light: #8d6e63;
            /* è–„èŒ¶ãƒ†ã‚­ã‚¹ãƒˆ */
        }

        body {
            font-family: 'Segoe UI', 'Hiragino Sans', sans-serif;
            background-color: var(--sky-light);
            /* ç›´è§’ä¸‰è§’å½¢ã®å¹¾ä½•å­¦æ¨¡æ§˜ï¼šæ–¹çœ¼ï¼‹å·¦ä¸‹ã‹ã‚‰å³ä¸Šã¸ã®å¯¾è§’ç·š */
            background-image: url("data:image/svg+xml,%3Csvg width='30' height='30' viewBox='0 0 30 30' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M0 30 L30 30 L30 0' fill='none' stroke='%23ffffff' stroke-width='1'/%3E%3Cpath d='M0 30 L30 0' fill='none' stroke='%23ffffff' stroke-width='1'/%3E%3C/svg%3E");
            background-size: 30px 30px;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }

        .game-container {
            background: var(--white);
            padding: 2rem;
            border-radius: 20px;
            box-shadow: 0 8px 32px rgba(66, 165, 245, 0.15);
            width: 95%;
            max-width: 480px;
            text-align: center;
            position: relative;
        }

        /* ã‚¿ã‚¤ãƒˆãƒ«ç”»é¢ */
        .title-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2.4rem;
        }

        .game-title {
            font-size: 2.2rem;
            font-weight: bold;
            color: var(--blue-dark);
        }

        .title-character {
            width: 144px;
            height: 144px;
            background: var(--sky-light);
            border: 5px solid var(--sky);
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 3.6rem;
            animation: float 3s ease-in-out infinite;
        }

        @keyframes float {

            0%,
            100% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(-10px);
            }
        }

        .start-btn {
            padding: 1.2rem 3.6rem;
            font-size: 1.56rem;
            font-weight: bold;
            color: var(--white);
            background: var(--blue);
            border: none;
            border-radius: 14px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .start-btn:hover {
            background: var(--blue-dark);
            transform: translateY(-2px);
        }

        /* ãƒ†ãƒ³ãƒé¸æŠãƒœã‚¿ãƒ³ */
        .tempo-buttons {
            display: flex;
            flex-direction: column;
            gap: 0.6rem;
            align-items: center;
            margin: 0.6rem 0;
        }

        .tempo-btn {
            padding: 0.58rem 2.4rem;
            font-size: 1.14rem;
            font-weight: bold;
            color: var(--white);
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
            width: 168px;
        }

        .tempo-btn.blue {
            background: #42a5f5;
        }

        .tempo-btn.blue:hover {
            background: #1e88e5;
        }

        .tempo-btn.green {
            background: #4caf50;
        }

        .tempo-btn.green:hover {
            background: #388e3c;
        }

        .tempo-btn.orange {
            background: #ff9800;
        }

        .tempo-btn.orange:hover {
            background: #f57c00;
        }

        .tempo-btn.red {
            background: #f44336;
        }

        .tempo-btn.red:hover {
            background: #d32f2f;
        }

        .tempo-btn.black {
            background: #333;
        }

        .tempo-btn.black:hover {
            background: #111;
        }

        .tempo-btn:hover {
            transform: translateY(-2px);
        }

        /* ã‚²ãƒ¼ãƒ ç”»é¢ */
        .game-screen {
            display: none;
            flex-direction: column;
            gap: 0.8rem;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 1rem;
            color: var(--text-light);
        }

        .back-btn {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: rgba(200, 215, 230, 0.5);
            border: 2px solid var(--sky);
            color: var(--text-light);
            font-size: 1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .back-btn:hover {
            background: rgba(180, 200, 220, 0.7);
            border-color: var(--blue);
        }

        .score {
            font-weight: bold;
            color: var(--blue-dark);
        }

        /* ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚¨ãƒªã‚¢ï¼ˆå·¦å³é…ç½®ï¼‰ */
        .characters-row {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            padding: 0 1rem;
            margin-bottom: 0.5rem;
            position: relative;
            z-index: 1;
            /* å¹ãå‡ºã—ã‚¨ãƒªã‚¢ï¼ˆz-index: 10ï¼‰ã‚ˆã‚Šå¾Œã‚ã« */
        }

        .character-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.3rem;
        }

        .character {
            width: 80px;
            height: 100px;
            background: var(--blue);
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1rem;
            font-weight: bold;
            color: var(--white);
            transition: transform 0.1s;
        }

        /* ã«ã¶ã¡ã‚ƒã‚“ç”»åƒã‚³ãƒ³ãƒ†ãƒŠï¼ˆå…¨ç”»åƒã‚’é‡ã­ã¦é…ç½®ï¼‰ */
        .character-img-container {
            position: relative;
            width: 210px;
            height: 140px;
            margin-bottom: -50px;
            z-index: 1;
            overflow: visible;
            transform: translateY(-8px);
            /* ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯ä¸Šã« */
        }

        /* è£æ‹ã§ä¸‹ã«æˆ»ã™ */
        .character-img-container.down {
            transform: translateY(0);
        }

        .nibu-img {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: auto;
            object-fit: contain;
            opacity: 0;
            transition: opacity 0.05s;
        }

        /* clap1ã¯è¡¨æ‹ï¼ˆä¸‹ä½ç½®ï¼‰ã€clap2ã¯è£æ‹ï¼ˆä¸Šä½ç½®=ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰ */
        .nibu-img[data-state="clap1"] {
            transform: translateY(8px);
        }

        .nibu-img.active {
            opacity: 1;
        }

        /* ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ãƒ†ãƒ­ãƒƒãƒ— */
        .countdown-overlay {
            position: absolute;
            top: 80px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 4rem;
            font-weight: 900;
            color: var(--blue-dark);
            text-shadow:
                -3px -3px 0 #fff,
                3px -3px 0 #fff,
                -3px 3px 0 #fff,
                3px 3px 0 #fff;
            z-index: 20;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.1s;
        }

        .countdown-overlay.show {
            opacity: 1;
            animation: countPop 0.3s ease-out;
        }

        @keyframes countPop {
            0% {
                transform: translateX(-50%) scale(0.5);
                opacity: 0;
            }

            50% {
                transform: translateX(-50%) scale(1.2);
                opacity: 1;
            }

            100% {
                transform: translateX(-50%) scale(1);
                opacity: 1;
            }
        }

        .character-name {
            font-size: 0.8rem;
            color: var(--text-light);
        }

        /* å¹ãå‡ºã—ã¨æ™‚é–“ãƒãƒ¼ã‚¨ãƒªã‚¢ */
        .speech-time-container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0;
            margin: 0.5rem 0;
            position: relative;
            z-index: 10;
            /* ç”»åƒã‚³ãƒ³ãƒ†ãƒŠã‚ˆã‚Šç¢ºå®Ÿã«å‰é¢ã« */
        }

        .speech-box {
            background: var(--white);
            border: 3px solid var(--blue);
            border-radius: 16px;
            padding: 0.5rem 0.6rem;
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--text-dark);
            /* ç”»é¢å¹…ã„ã£ã±ã„ã«ä¼¸ã°ã™ï¼ˆflexã§å‡ç­‰åˆ†å‰²ï¼‰ */
            flex: 1;
            /* é«˜ã•ã¯å›ºå®š */
            height: 48px;
            min-height: 48px;
            text-align: center;
            position: relative;
            box-sizing: border-box;
            overflow: hidden;
            white-space: nowrap;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 5;
            /* ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ç”»åƒã®å‰é¢ã« */
        }

        .speech-box.left {
            border-top-right-radius: 0;
            border-bottom-right-radius: 0;
            border-right: none;
            justify-content: flex-end;
            padding-right: 20px;
            /* ãƒã‚¤ãƒŠã‚¹ãƒãƒ¼ã‚¸ãƒ³åˆ†ã‚’è£œå„Ÿã—ã¦æ–‡å­—ä½ç½®ã‚’ç¶­æŒ */
            margin-right: -20px;
            /* ä¸­å¤®å††ã®ä¸‹ã«ä¼¸ã°ã™ */
        }

        .speech-box.right {
            border-top-left-radius: 0;
            border-bottom-left-radius: 0;
            border-left: none;
            justify-content: flex-start;
            padding-left: 20px;
            /* ãƒã‚¤ãƒŠã‚¹ãƒãƒ¼ã‚¸ãƒ³åˆ†ã‚’è£œå„Ÿã—ã¦æ–‡å­—ä½ç½®ã‚’ç¶­æŒ */
            margin-left: -20px;
            /* ä¸­å¤®å††ã®ä¸‹ã«ä¼¸ã°ã™ */
        }

        /* ãƒ›ãƒ¯ã‚¤ãƒˆã‚¦ã‚©ãƒƒã‚·ãƒ¥ï¼ˆè–„ãã™ã‚‹ï¼‰åŠ¹æœ - èƒŒæ™¯ã¯ä¸é€æ˜ã€æ–‡å­—ã¨ãƒœãƒ¼ãƒ€ãƒ¼ã‚’è–„ã */
        .speech-box.whitewash {
            background: #fff;
            border-color: #cce0f0;
            color: #bbb;
            transition: all 0.2s;
        }

        .center-indicator {
            position: relative;
            z-index: 15;
            /* å¹ãå‡ºã—ï¼ˆz-index: 5ï¼‰ã‚ˆã‚Šå‰é¢ã« */
            flex-shrink: 0;
        }

        .next-char-circle {
            width: 72px;
            height: 72px;
            background: var(--white);
            border: 4px solid var(--blue);
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 2.4rem;
            font-weight: bold;
            color: var(--text-dark);
            position: relative;
        }

        /* ä¸­å¤®å††ã®è£œåŠ©æ–‡å­—ï¼ˆå°ã•ã„ã€Œã‚ƒã€ã€Œãƒ¼ã€ãªã©ï¼‰ */
        .next-char-circle .sub-char {
            position: absolute;
            font-size: 1.35rem;
            font-weight: bold;
            bottom: -3px;
            right: 10px;
            text-shadow:
                -2px -2px 0 #fff,
                2px -2px 0 #fff,
                -2px 2px 0 #fff,
                2px 2px 0 #fff,
                0 -2px 0 #fff,
                0 2px 0 #fff,
                -2px 0 0 #fff,
                2px 0 0 #fff;
        }

        /* å¹ãå‡ºã—ã®ã—ã£ã½ï¼ˆä¸Šå‘ãï¼‰ */
        .next-char-circle::before {
            content: '';
            position: absolute;
            top: -14px;
            width: 0;
            height: 0;
            border-left: 12px solid transparent;
            border-right: 12px solid transparent;
            border-bottom: 14px solid var(--blue);
            transition: left 0.2s, right 0.2s;
        }

        .next-char-circle::after {
            content: '';
            position: absolute;
            top: -9px;
            width: 0;
            height: 0;
            border-left: 10px solid transparent;
            border-right: 10px solid transparent;
            border-bottom: 12px solid var(--white);
            transition: left 0.2s, right 0.2s;
        }

        /* ã—ã£ã½ãŒå·¦ï¼ˆæç¤ºäººï¼‰ã‚’å‘ã */
        .next-char-circle.tail-left::before {
            left: 10px;
            right: auto;
        }

        .next-char-circle.tail-left::after {
            left: 12px;
            right: auto;
        }

        /* ã—ã£ã½ãŒå³ï¼ˆã«ã¶ã¡ã‚ƒã‚“ï¼‰ã‚’å‘ã */
        .next-char-circle.tail-right::before {
            right: 10px;
            left: auto;
        }

        .next-char-circle.tail-right::after {
            right: 12px;
            left: auto;
        }

        /* æ¥•å††æ ã®æ®‹ã‚Šæ™‚é–“ãƒãƒ¼ï¼ˆå·¦å³ã‹ã‚‰ä¸­å¤®ã¸ï¼‰ */
        .time-bar-frame {
            width: 90%;
            height: 12px;
            margin: 0.5rem auto;
            position: relative;
            display: flex;
            justify-content: center;
            border-radius: 6px;
            overflow: hidden;
        }

        .time-bar-half {
            height: 100%;
            background: #4caf50;
            transition: width 0.1s linear;
        }

        .time-bar-half.left {
            border-radius: 6px 0 0 6px;
        }

        .time-bar-half.right {
            border-radius: 0 6px 6px 0;
        }

        .time-bar-half.warning {
            background: #ff9800;
        }

        .time-bar-half.danger {
            background: #f44336;
        }

        /* æ­£è§£ï¼ä¸æ­£è§£ãƒãƒ¼ã‚¯ */
        .judgment-mark {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 4rem;
            font-weight: 900;
            display: none;
            z-index: 20;
            /* å††ï¼ˆz-index: 15ï¼‰ã‚ˆã‚Šå‰é¢ã« */
            text-shadow:
                -3px -3px 0 #fff,
                3px -3px 0 #fff,
                -3px 3px 0 #fff,
                3px 3px 0 #fff,
                0 -3px 0 #fff,
                0 3px 0 #fff,
                -3px 0 0 #fff,
                3px 0 0 #fff;
        }

        .judgment-mark.correct {
            color: #f44336;
        }

        .judgment-mark.wrong {
            color: #2196f3;
        }

        .judgment-mark.show {
            display: block;
            animation: popIn 0.2s ease-out;
        }

        @keyframes popIn {
            0% {
                transform: translate(-50%, -50%) scale(0);
            }

            70% {
                transform: translate(-50%, -50%) scale(1.2);
            }

            100% {
                transform: translate(-50%, -50%) scale(1);
            }
        }

        /* é¸æŠè‚¢ */
        .choices {
            display: flex;
            justify-content: center;
            gap: 12px;
            flex-wrap: nowrap;
        }

        .choice-btn {
            writing-mode: vertical-rl;
            text-orientation: upright;
            padding: 0.75rem 0.6rem;
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--text-dark);
            background: var(--white);
            border: 3px solid var(--sky);
            border-radius: 16px;
            cursor: pointer;
            transition: all 0.15s;
            /* ã€ŒãŸã‚‹ãŸã‚‹ã¡ãã‚“ã€ãŒå…¥ã‚‹å›ºå®šé«˜ã•ï¼ˆ1.5å€ï¼‰ */
            height: 240px;
            min-height: 240px;
            max-height: 240px;
            text-align: center;
            /* ç¸¦æ–¹å‘ã®ä¸­å¤®ç·šã‚’æƒãˆã‚‹ */
            box-sizing: border-box;
        }

        .choice-btn:hover:not(:disabled):not(.selected) {
            background: var(--sky-light);
            border-color: var(--sky);
        }

        .choice-btn.selected {
            background: var(--blue);
            color: var(--white);
            border-color: var(--blue);
        }

        /* é¸æŠã•ã‚Œã¦ã„ãªã„disabledãƒœã‚¿ãƒ³ã®ã¿è–„ãã™ã‚‹ */
        .choice-btn:disabled:not(.selected) {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* é¸æŠã•ã‚ŒãŸãƒœã‚¿ãƒ³ã¯disabledã§ã‚‚åŸè‰²ã®ã¾ã¾ */
        .choice-btn.selected:disabled {
            opacity: 1;
            cursor: default;
        }

        .choice-btn .first-char {
            font-size: 1.8rem;
            font-weight: bold;
        }

        .choice-btn .rest-chars {
            font-size: 1.2rem;
        }

        /* çµæœè¡¨ç¤º */
        .result-overlay {
            display: none;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--white);
            border-radius: 20px;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 1.5rem;
            z-index: 10;
        }

        .result-emoji {
            font-size: 5rem;
        }

        .result-text {
            font-size: 2rem;
            font-weight: bold;
            color: var(--blue-dark);
        }

        .result-text.win {
            color: #ff7043;
        }

        .result-text.lose {
            color: var(--text-light);
        }

        .result-score {
            font-size: 1.2rem;
            color: var(--text-light);
        }

        .result-img {
            max-width: 90%;
            max-height: 300px;
            border-radius: 12px;
        }

        .retry-btn {
            padding: 1rem 2.5rem;
            font-size: 1.1rem;
            font-weight: bold;
            color: var(--white);
            background: var(--blue);
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .retry-btn:hover {
            background: var(--blue-dark);
            transform: translateY(-2px);
        }
    </style>
</head>

<body>

    <div class="game-container">
        <!-- ã‚¿ã‚¤ãƒˆãƒ«ç”»é¢ -->
        <div id="title-screen" class="title-screen">
            <h1 class="game-title">ãªã‚“ã§ã‚‚<br>ã‚¿ãƒ«ã‚¿ãƒ«ãƒã‚­ãƒ³ã«<br>ã™ã‚‹ã‚²ãƒ¼ãƒ </h1>
            <div class="title-character">ğŸ¤</div>
            <p style="color: var(--text-light); font-size: 1.14rem;">
                ã—ã‚Šã¨ã‚Šã§ã‚¿ãƒ«ã‚¿ãƒ«ãƒã‚­ãƒ³ã«å°ã“ã†ï¼
            </p>
            <div class="tempo-buttons">
                <button class="tempo-btn blue" onclick="startGame(80)">ã‚†ã£ãã‚Š</button>
                <button class="tempo-btn green" onclick="startGame(120)">ãµã¤ã†</button>
                <button id="btn-fast" class="tempo-btn orange" onclick="startGame(160)">ã¯ã‚„ã„</button>
                <button id="btn-gekihaya" class="tempo-btn red" onclick="startGame(200)"
                    style="display: none;">ã’ãã¯ã‚„</button>
                <button id="btn-onihaya" class="tempo-btn black" onclick="startGame(300)"
                    style="display: none;">ãŠã«ã¯ã‚„</button>
            </div>
        </div>

        <!-- ã‚²ãƒ¼ãƒ ç”»é¢ -->
        <div id="game-screen" class="game-screen">
            <div class="header">
                <button class="back-btn" onclick="goToTitle()" title="ã‚¹ã‚¿ãƒ¼ãƒˆã«æˆ»ã‚‹">â¬…</button>
                <span></span>
                <span class="score">ã‚¿ãƒ¼ãƒ³: <span id="score">0</span></span>
            </div>

            <!-- å·¦å³ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼é…ç½® -->
            <div class="characters-row">
                <div class="character-wrapper">
                    <div id="presenter-char" class="character">ææ¡ˆäºº</div>
                    <span class="character-name"></span>
                </div>
                <div class="character-wrapper">
                    <div id="nibu-char-container" class="character-img-container">
                        <img class="nibu-img active" data-state="waiting"
                            src="https://github.com/taltalhobby/shiritori-game/blob/main/images/01-nibu-wait.png?raw=true"
                            alt="å¾…æ©Ÿ">
                        <img class="nibu-img" data-state="request"
                            src="https://github.com/taltalhobby/shiritori-game/blob/main/images/02-nibu-listen.png?raw=true"
                            alt="ãƒªã‚¯ã‚¨ã‚¹ãƒˆ">
                        <img class="nibu-img" data-state="clap1"
                            src="https://github.com/taltalhobby/shiritori-game/blob/main/images/03-nibu-clap1.png?raw=true"
                            alt="æ‹æ‰‹1">
                        <img class="nibu-img" data-state="clap2"
                            src="https://github.com/taltalhobby/shiritori-game/blob/main/images/04-nibu-clap2.png?raw=true"
                            alt="æ‹æ‰‹2">
                        <img class="nibu-img" data-state="correct"
                            src="https://github.com/taltalhobby/shiritori-game/blob/main/images/05-nibu-correct.png?raw=true"
                            alt="æ­£è§£">
                        <img class="nibu-img" data-state="goal"
                            src="https://github.com/taltalhobby/shiritori-game/blob/main/images/06-nibu-tartarchicken.png?raw=true"
                            alt="ã‚¿ãƒ«ã‚¿ãƒ«ãƒã‚­ãƒ³">
                        <img class="nibu-img" data-state="fail"
                            src="https://github.com/taltalhobby/shiritori-game/blob/main/images/07-nibu-fail.png?raw=true"
                            alt="å¤±æ•—">
                    </div>
                    <span class="character-name"></span>
                </div>
            </div>

            <!-- ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ãƒ†ãƒ­ãƒƒãƒ— -->
            <div id="countdown-overlay" class="countdown-overlay"></div>

            <!-- å¹ãå‡ºã—ï¼‹æ¬¡ã®é ­æ–‡å­— -->
            <div class="speech-time-container">
                <div id="speech-left" class="speech-box left">---</div>
                <div class="center-indicator">
                    <div id="next-char" class="next-char-circle"></div>
                </div>
                <div id="speech-right" class="speech-box right">---</div>
                <div id="judgment-mark" class="judgment-mark"></div>
            </div>

            <!-- æ®‹ã‚Šæ™‚é–“ãƒãƒ¼ï¼ˆå·¦å³ã‹ã‚‰ä¸­å¤®ã¸ï¼‰ -->
            <div class="time-bar-frame">
                <div id="time-bar-left" class="time-bar-half left" style="width: 50%;"></div>
                <div id="time-bar-right" class="time-bar-half right" style="width: 50%;"></div>
            </div>

            <div id="choices" class="choices"></div>
        </div>

        <!-- çµæœç”»é¢ -->
        <div id="result-overlay" class="result-overlay">
            <div id="result-content"></div>
            <button class="retry-btn" onclick="goToTitle()">ğŸ”„ ã‚‚ã†ä¸€åº¦éŠã¶</button>
        </div>
    </div>

    <script>
        // ========== å˜èªè¾æ›¸ ==========
        const wordDict = {
            "ã‚": ["ã‚ã–ã¨ã‹ã‚ã„ã„", "ã‚ã²ã‚‹", "ã‚ã‚", "ã‚ã„ã™", "ã‚ã—ãŸ", "ã‚ã‚“ã±ã‚“"],
            "ã„": ["ã„ã‹", "ã„ã¬", "ã„ã¡ã”", "ã„ã™", "ã„ãŸ", "ã„ã‚“ã‹ã‚“"],
            "ã†": ["ã†ã•ã", "ã†ã—", "ã†ã¿", "ã†ã¡ã‚", "ã†ãŸ", "ã†ã©ã‚“"],
            "ãˆ": ["ãˆã ã¾ã‚", "ãˆã‚“ã´ã¤", "ãˆã³", "ãˆã‹ã", "ãˆã‚“ã®ã—ãŸ", "ãˆãã§ã‚“"],
            "ãŠ": ["ãŠã«ãã‚Š", "ãŠãŠã‹ã¿", "ãŠã‚‚ã¡ã‚ƒ", "ãŠã‚„ã¤", "ãŠãŠãã‚ãŒãŸ", "ãŠã‚“ã›ã‚“"],
            "ã‹": ["ã‹ã™ãŒ", "ã‹ã‚‰ã™", "ã‹ã•", "ã‹ã‚", "ã‹ãŸ", "ã‹ãµã‡ã„ã‚“"],
            "ã": ["ãã®ã“", "ããã‚‰ã’", "ãã¤ã­", "ãã‚“ãã‚‡", "ããŸ", "ãã‚…ã‚“"],
            "ã": ["ãã‚‹ã¾", "ãã˜ã‚‰", "ãã¤ãã“", "ãã‚Š", "ãã¤ã—ãŸ", "ãã£ã—ã‚‡ã‚“"],
            "ã‘": ["ã‘ã‚“ã ã¾", "ã‘ãƒ¼ã", "ã‘ã—ã”ã‚€", "ã‘ã‚“ã©ã†", "ã‘ã—ã‚‡ã†ã„ãŸ", "ã‘ã„ã‹ã‚“"],
            "ã“": ["ã“ã‚ã‚‰", "ã“ã‚“ã¶", "ã“ã¾", "ã“ã¨ã‚Š", "ã“ã­ããŸãƒ¼", "ã“ã°ã‚“"],
            "ã•": ["ã•ã„ãŸã¾", "ã•ã‚‹", "ã•ãã‚‰", "ã•ã‹ãª", "ã•ã™ã¾ãŸ", "ã•ã„ã°ã‚“"],
            "ã—": ["ã—ã‹", "ã—ãŠ", "ã—ã˜ã¿", "ã—ã—ã‚ƒã‚‚", "ã—ãŸ", "ã—ã‚“ã¶ã‚“"],
            "ã™": ["ã™ã„ã‹", "ã™ãšã‚", "ã™ãª", "ã™ã¦ãƒ¼ã", "ã™ãŒãŸ", "ã™ã†ã‡ãƒ¼ã§ã‚“"],
            "ã›": ["ã›ã¿", "ã›ã‚“ã›ã„", "ã›ã‚“ãŸã", "ã›ãªã‹", "ã›ã£ãŸ", "ã›ã£ã‘ã‚“"],
            "ã": ["ãã‚“ãªã“ã¨ãªã„ã‚ˆ", "ãã‚‰", "ãã¼ã‚", "ããµã¨", "ããªãŸ", "ãã‚ã°ã‚“"],
            "ãŸ": ["ãŸã¬ã", "ãŸã„ã“", "ãŸã¾ã”", "ãŸã„ã‚ˆã†", "ãŸãªã°ãŸ", "ãŸã‚‹ãŸã‚‹ã¡ãã‚“"],
            "ã¡": ["ã¡ãƒ¼ãš", "ã¡ãã‚…ã†", "ã¡ã‚‡ã†ã¡ã‚‡", "ã¡ã‹ã¦ã¤", "ã¡ã‚ƒãã†ãŸ", "ã¡ãã‚“ãªã‚“ã°ã‚“"],
            "ã¤": ["ã¤ããˆ", "ã¤ã°ã‚", "ã¤ã¿ã", "ã¤ã‚Š", "ã¤ãŸ", "ã¤ãªã‹ã‚“"],
            "ã¦": ["ã¦ãŒã¿", "ã¦ã‚Œã³", "ã¦ã‚“ã¨ã†ã‚€ã—", "ã¦ã‚“ã", "ã¦ãŒãŸ", "ã¦ã£ã‘ã‚“"],
            "ã¨": ["ã¨ã‚‰", "ã¨ã‘ã„", "ã¨ã¡ã", "ã¨ã†ã‚‚ã‚ã“ã—", "ã¨ã—ã—ãŸ", "ã¨ã†ã‚ã„ã‹ã‚“"],
            "ãª": ["ãªã™", "ãªã£ã¨ã†", "ãªã¿", "ãªã‹ã¾", "ãªãŸ", "ãªã„ã‚ã‚“"],
            "ã«": ["ã«ã˜", "ã«ã‚ã¨ã‚Š", "ã«ã‚“ãã‚‡ã†", "ã«ã‚…ãƒ¼ã™", "ã«ã„ãŒãŸ", "ã«ã¶ã¡ã‚ƒã‚“"],
            "ã¬": ["ã¬ã‚Šãˆ", "ã¬ã¾", "ã¬ã‘ãŒã‚‰", "ã¬ãƒ¼ã©ã‚‹", "ã¬ã¾ãŸ", "ã¬ã‚‰ã‚Šã²ã‚‡ã‚“"],
            "ã­": ["ã­ã“", "ã­ããŸã„", "ã­ãšã¿", "ã­ã„ã‚", "ã­ãŸ", "ã­ãã‚‰ãƒ¼ã‚ã‚“"],
            "ã®": ["ã®ã‚Š", "ã®ãƒ¼ã¨", "ã®ã¿ã‚‚ã®", "ã®ã©", "ã®ãã—ãŸ", "ã®ãƒ¼ã¨ã±ãã“ã‚“"],
            "ã¯": ["ã¯ã‚“ã°ãƒ¼ãŒãƒ¼", "ã¯ãª", "ã¯ã•ã¿", "ã¯ã—", "ã¯ã‚€ã™ãŸãƒ¼", "ã¯ãã¶ã¤ã‹ã‚“"],
            "ã²": ["ã²ã¤ã˜", "ã²ã“ã†ã", "ã²ã¾ã‚ã‚Š", "ã²ã‹ã’", "ã²ãªãŸ", "ã²ãŒã—ã«ã»ã‚“"],
            "ãµ": ["ãµã­", "ãµã§", "ãµã", "ãµã†ã¨ã†", "ãµãŸ", "ãµã†ã›ã‚“"],
            "ã¸": ["ã¸ã³", "ã¸ã‚„", "ã¸ã", "ã¸ã‚‹ã‚ã£ã¨", "ã¸ã‚Šã“ã·ãŸãƒ¼", "ã¸ã‚“ã—ã‚“"],
            "ã»": ["ã»ã—", "ã»ã†ã‚Œã‚“ãã†", "ã»ã†ã›ã", "ã»ã­", "ã»ã£ãºãŸ", "ã»ã‚“"],
            "ã¾": ["ã¾ã£ã¡ã‚ƒ", "ã¾ã¤ã‚Š", "ã¾ãã‚‰", "ã¾ã‚", "ã¾ã‚“ãŸ", "ã¾ã‚‰ãã‚“"],
            "ã¿": ["ã¿ã‚„ã–ã", "ã¿ãš", "ã¿ã¿ãšã", "ã¿ã‚‰ã„", "ã¿ã‹ãŸ", "ã¿ã‹ã‚“"],
            "ã‚€": ["ã‚€ã—", "ã‚€ã", "ã‚€ã™ã‚", "ã‚€ã‚‰", "ã‚€ãªã„ãŸ", "ã‚€ã›ã‚“"],
            "ã‚": ["ã‚ã ã‹", "ã‚ãŒã­", "ã‚ã„ã‚", "ã‚ã„ã—", "ã‚ã£ãŸ", "ã‚ã‚ã‚“"],
            "ã‚‚": ["ã‚‚ã‚‚", "ã‚‚ã¡", "ã‚‚ãã‚‰", "ã‚‚ã‚Š", "ã‚‚ã¡ã†ãŸ", "ã‚‚ã£ãã‚“"],
            "ã‚„": ["ã‚„ã", "ã‚„ã¾", "ã‚„ã•ã—ã„ã‹ã‚“ã‘ã„", "ã‚„ã­", "ã‚„ã‹ãŸ", "ã‚„ã‹ã‚“"],
            "ã‚†": ["ã‚†ã", "ã‚†ã³ã‚", "ã‚†ã†ã‚Œã„", "ã‚†ã‚", "ã‚†ã‹ãŸ", "ã‚†ã†ã³ã‚“"],
            "ã‚ˆ": ["ã‚ˆã£ã¨", "ã‚ˆã‚‹", "ã‚ˆã†ã‹ã„", "ã‚ˆã†ãµã", "ã‚ˆã‚‹ãŒãŸ", "ã‚ˆã˜ã’ã‚“"],
            "ã‚‰": ["ã‚‰ã£ã±", "ã‚‰ãã ", "ã‚‰ã˜ãŠ", "ã‚‰ã‚“ã©ã›ã‚‹", "ã‚‰ã„ãŸãƒ¼", "ã‚‰ã„ãŠã‚“"],
            "ã‚Š": ["ã‚Šã‚“ã”", "ã‚Šã™", "ã‚Šã‚…ã£ã", "ã‚Šãã—", "ã‚Šã‚…ã†ã‘ã¤ã–ãŸ", "ã‚Šã¼ã‚“"],
            "ã‚‹": ["ã‚‹ãƒ¼ãº", "ã‚‹ãƒ¼ã‚‹", "ã‚‹ã³ãƒ¼", "ã‚‹ãƒ¼ã‚Œã£ã¨", "ã‚‹ãŸãƒ¼", "ã‚‹ãµã‚‰ã‚“"],
            "ã‚Œ": ["ã‚Œã„ãã†ã“", "ã‚Œã‚“ã’", "ã‚Œã‚“ãš", "ã‚ŒãŸã™", "ã‚ŒãŸãƒ¼", "ã‚Œã‚“ã“ã‚“"],
            "ã‚": ["ã‚ã‘ã£ã¨", "ã‚ã°", "ã‚ã†ãã", "ã‚ãƒ¼ã·", "ã‚ã‹ãŸ", "ã‚ã‚“ã©ã‚“"],
            "ã‚": ["ã‚ã‚“ã¡ã‚‡ã„ã™", "ã‚ã‹ã°ã‚„ã—", "ã‚ãŸã‚ã‚", "ã‚ã«", "ã‚ãŸ", "ã‚ã•ã‚“ã¼ã‚“"],
            "ãŒ": ["ãŒã‚‰ã™", "ãŒã£ã“ã†", "ãŒãƒ¼ãœ", "ãŒã‹", "ãŒã‚‰ã™ã„ãŸ", "ãŒãã‚Šã‚“"],
            "ã": ["ãã‚…ã†ã«ã‚…ã†", "ãã‚“ãŒ", "ãã‚‡ã†ã–", "ãã‚…ã†ã«ã", "ããŸãƒ¼", "ãã‚“ãªã‚“"],
            "ã": ["ãã¿", "ãã‚“ã¦", "ãã‚‰ã™", "ãã‚“ã¾", "ãã‚“ã˜ã§ãƒ¼ãŸ", "ãã‚‰ãŸã‚“"],
            "ã’": ["ã’ãƒ¼ã‚€", "ã’ã‚“ã", "ã’ã‹", "ã’ã‚“ã¾ã„", "ã’ãŸ", "ã’ãƒ¼ã›ã‚“"],
            "ã”": ["ã”ã‚Šã‚‰", "ã”ã‚€", "ã”ã‚‹ãµ", "ã”ã¾", "ã”ã¶ã•ãŸ", "ã”ã¯ã‚“"],
            "ã–": ["ã–ã£ã—", "ã–ã‚‰ã‚", "ã–ã‚ŠãŒã«", "ã–ã›ã", "ã–ã£ãŸ", "ã–ã¶ã¨ã‚“"],
            "ã˜": ["ã˜ã“ã†", "ã˜ã¦ã‚“ã—ã‚ƒ", "ã˜ã—ã‚ƒã", "ã˜ã—ã‚‡", "ã˜ã¹ãŸ", "ã˜ã‹ã‚“"],
            "ãš": ["ãšã“ã†", "ãšã‘ã„", "ãšã‚ã„ãŒã«", "ãšã‚“ã ", "ãšã„ãŸ", "ãšã¼ã‚“"],
            "ãœ": ["ãœã‚Šãƒ¼", "ãœã‚“ã‚Šã", "ãœã‚“ã¾ã„", "ãœã‚", "ãœã«ãŒãŸ", "ãœã£ã´ã‚“"],
            "ã": ["ãã†", "ãã†ã‚Š", "ãã‚“ã³", "ãã†ãœã„", "ãã‚ã‚ã™ãŸãƒ¼", "ãã†ãã‚“"],
            "ã ": ["ã ã‚“ã”", "ã ã„ã‚„", "ã ã‚‹ã¾", "ã ã‚“ã™", "ã ãƒ¼ãã¾ãŸãƒ¼", "ã ã„ã“ã‚“"],
            "ã§": ["ã§ã‚“ã—ã‚ƒ", "ã§ã‚“ã‚", "ã§ã‚“ã", "ã§ã±ãƒ¼ã¨", "ã§ãƒã‚ŒããŸãƒ¼", "ã§ã˜ãŸã‚‹ãºã‚“"],
            "ã©": ["ã©ã‚Œã¿ãã‚‰ã—ã©", "ã©ãƒ¼ãªã¤", "ã©ã‚", "ã©ã‚“ãã‚Š", "ã©ããŸãƒ¼", "ã©ã‚‰ã”ã‚“"],
            "ã°": ["ã°ãªãª", "ã°ã„ã", "ã°ã‘ã¤", "ã°ã‚‰", "ã°ã£ãŸ", "ã°ãã ã‚“"],
            "ã³": ["ã³ãƒ¼ã ã¾", "ã³ãƒ¼ã‚‹", "ã³ã‚", "ã³ã§ãŠ", "ã³ãŸãƒ¼", "ã³ã‚“"],
            "ã¶": ["ã¶ã—", "ã¶ã©ã†", "ã¶ã‚‰ã‚“ã“", "ã¶ã‚ã£ã“ã‚Šãƒ¼", "ã¶ãŸ", "ã¶ã©ã†ã±ã‚“"],
            "ã¹": ["ã¹ã‚“ã¨ã†", "ã¹ã‚‹ã¨", "ã¹ã‚“ã¡", "ã¹ã£ã©", "ã¹ã«ã‚„ã„ãŸ", "ã¹ãƒ¼ã“ã‚“"],
            "ã¼": ["ã¼ãƒ¼ã‚‹", "ã¼ã†ã—", "ã¼ãã˜ã‚‡ã†", "ã¼ã‚“ãŠã©ã‚Š", "ã¼ã‚“ã¼ã‚Šã†ãŸ", "ã¼ãŸã‚“"],
            "ã±": ["ã±ã‚“ã ", "ã±ã›ã‚Š", "ã±ã‚‰ãã‚‹", "ã±ã¨ã‹ãƒ¼", "ã±ã™ãŸ", "ã±ãã“ã‚“"],
            "ã´": ["ã´ã‚ã®", "ã´ã‚“ã", "ã´ã™ã¨ã‚‹", "ã´ã–", "ã´ãƒ¼ãªã¤ã°ãŸãƒ¼", "ã´ãƒ¼ã¾ã‚“"],
            "ã·": ["ã·ã‚Œãœã‚“ã¨", "ã·ãƒ¼ã‚‹", "ã·ã‚‰ã", "ã·ã‚ã‚Œã™", "ã·ã‚Šã‚“ãŸãƒ¼", "ã·ã‚Šã‚“"],
            "ãº": ["ãºãƒ¼ã±ãƒ¼", "ãºã‚“ã", "ãºã£ã¨", "ãºã ã‚‹", "ãºã„ã‚“ãŸãƒ¼", "ãºã‚“ãã‚“"],
            "ã½": ["ã½ã™ã¨", "ã½ã¦ã¨", "ã½ã‚“ã·", "ã½ã‘ã£ã¨", "ã½ã™ãŸãƒ¼", "ã½ã£ã·ã“ãƒ¼ã‚“"],
            "ã¡ã‚ƒ": ["ã¡ã‚ƒã°", "ã¡ã‚ƒã„ã‚", "ã¡ã‚ƒã—ã¤", "ã¡ã‚ƒã‚“ã½ã‚“"]
        };

        // ã‚³ãƒ³ãƒœãƒã‚§ãƒ¼ãƒ³å®šç¾©
        // ã¾â†’ã¾ã£ã¡ã‚ƒâ†’ã¡ã‚ƒã°â†’ã°ã£ãŸâ†’ãŸâ†’ãŸã‚‹ãŸã‚‹ã¡ãã‚“
        // ã©/ã¤/ãâ†’ã©ãƒ¼ãªã¤â†’ã¤ã¿ãâ†’ããŸâ†’ãŸâ†’ãŸã‚‹ãŸã‚‹ã¡ãã‚“
        // ã†â†’ã†ãŸâ†’ãŸâ†’ãŸã‚‹ãŸã‚‹ã¡ãã‚“
        // ã„â†’ã„ãŸâ†’ãŸâ†’ãŸã‚‹ãŸã‚‹ã¡ãã‚“
        const combo = {
            // ã¾ã£ã¡ã‚ƒãƒã‚§ãƒ¼ãƒ³
            "ã¾ã£ã¡ã‚ƒ": "ã¡ã‚ƒã°",
            "ã¡ã‚ƒã°": "ã°ã£ãŸ",
            "ã°ã£ãŸ": "ãŸã‚‹ãŸã‚‹ã¡ãã‚“",
            // ã©ãƒ¼ãªã¤ãƒã‚§ãƒ¼ãƒ³
            "ã©ãƒ¼ãªã¤": "ã¤ã¿ã",
            "ã¤ã¿ã": "ããŸ",
            "ããŸ": "ãŸã‚‹ãŸã‚‹ã¡ãã‚“",
            // ã†ãŸãƒã‚§ãƒ¼ãƒ³
            "ã†ãŸ": "ãŸã‚‹ãŸã‚‹ã¡ãã‚“",
            // ã„ãŸãƒã‚§ãƒ¼ãƒ³
            "ã„ãŸ": "ãŸã‚‹ãŸã‚‹ã¡ãã‚“",
            // ã™ã„ã‹ãƒã‚§ãƒ¼ãƒ³
            "ã™ã„ã‹": "ã‹ãŸ",
            "ã‹ãŸ": "ãŸã‚‹ãŸã‚‹ã¡ãã‚“",
            // === è² ã‘ã‚³ãƒ³ãƒœ ===
            // ã†ã•ããƒã‚§ãƒ¼ãƒ³ï¼ˆãã‚“ãªã‚“ã§çµ‚ã‚ã‚Šï¼‰
            "ã†ã•ã": "ãã‚“ãªã‚“",
            // ãã¤ãã“ãƒã‚§ãƒ¼ãƒ³ï¼ˆã“ã°ã‚“ã§çµ‚ã‚ã‚Šï¼‰
            "ãã¤ãã“": "ã“ã°ã‚“"
        };

        // ç‰¹å®šã®æ–‡å­—ã‹ã‚‰å§‹ã¾ã‚‹ã¹ãã‚³ãƒ³ãƒœå˜èª
        const comboStarters = {
            "ã¾": "ã¾ã£ã¡ã‚ƒ",
            "ã¡": "ã¡ã‚ƒã°",    // é€”ä¸­ã‹ã‚‰ã§ã‚‚
            "ã°": "ã°ã£ãŸ",    // é€”ä¸­ã‹ã‚‰ã§ã‚‚
            "ã©": "ã©ãƒ¼ãªã¤",
            "ã¤": "ã¤ã¿ã",    // é€”ä¸­ã‹ã‚‰ã§ã‚‚
            "ã": "ããŸ",      // é€”ä¸­ã‹ã‚‰ã§ã‚‚
            "ã†": "ã†ãŸ",      // å‹ã¡ã‚³ãƒ³ãƒœï¼ˆè² ã‘ã‚³ãƒ³ãƒœã®ã†ã•ãã‚‚é¸æŠè‚¢ã«å‡ºã‚‹ï¼‰
            "ã„": "ã„ãŸ",
            "ã™": "ã™ã„ã‹",    // ã™ã„ã‹ãƒã‚§ãƒ¼ãƒ³
            "ã‹": "ã‹ãŸ"       // é€”ä¸­ã‹ã‚‰ã§ã‚‚
        };

        // è² ã‘ã‚³ãƒ³ãƒœã‚¹ã‚¿ãƒ¼ã‚¿ãƒ¼ï¼ˆå‹ã¡ã‚³ãƒ³ãƒœã¨åŒã˜æ–‡å­—ã‹ã‚‰å§‹ã¾ã‚‹ãŒã€è² ã‘ã«å°ãï¼‰
        const loseComboStarters = {
            "ã†": "ã†ã•ã",    // ã†â†’ã†ã•ãâ†’ãã‚“ãªã‚“ï¼ˆè² ã‘ï¼‰
            "ã": "ãã¤ãã“"  // ãâ†’ãã¤ãã“â†’ã“ã°ã‚“ï¼ˆè² ã‘ï¼‰
        };

        // ========== ã‚²ãƒ¼ãƒ çŠ¶æ…‹ ==========
        let currentWord = "";
        let score = 0;
        let taVisitCount = 0; // äº’æ›æ€§ã®ãŸã‚æ®‹ã™ãŒä½¿ç”¨ã—ãªã„
        let selectedWord = null;
        let isPlaying = false;
        let currentBeat = 0; // 1-8 (2å°ç¯€)
        let beatInterval = null;
        let gamePhase = "intro"; // "intro" or "select" or "answer"
        let timeBarInterval = null;
        let timeBarWidth = 100;
        let choicesShown = false; // é¸æŠè‚¢ãŒè¡¨ç¤ºã•ã‚ŒãŸã‹ã©ã†ã‹
        let cycleCount = 0; // ã‚³ãƒ¼ãƒ‰é€²è¡Œç”¨ã‚µã‚¤ã‚¯ãƒ«ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼
        let isFirstTurn = true; // 1ã‚¿ãƒ¼ãƒ³ç›®ã‹ã©ã†ã‹ï¼ˆã—ã£ã½ã®å‘ãåˆ¶å¾¡ç”¨ï¼‰
        let currentBPM = 120; // ç¾åœ¨ã®ã‚²ãƒ¼ãƒ ã®BPMï¼ˆã‚¢ãƒ³ãƒ­ãƒƒã‚¯åˆ¤å®šç”¨ï¼‰

        // é›£æ˜“åº¦ã‚¢ãƒ³ãƒ­ãƒƒã‚¯çŠ¶æ…‹ï¼ˆã‚»ãƒƒã‚·ãƒ§ãƒ³ä¸­ã®ã¿æœ‰åŠ¹ï¼‰
        let unlockedGekihaya = false;
        let unlockedOnihaya = false;

        // ========== ã‚²ãƒ¼ãƒ ç”»åƒ ==========
        const NIBU_IMAGES = {
            waiting: "https://github.com/taltalhobby/shiritori-game/blob/main/images/01-nibu-wait.png?raw=true",
            request: "https://github.com/taltalhobby/shiritori-game/blob/main/images/02-nibu-listen.png?raw=true",
            clap1: "https://github.com/taltalhobby/shiritori-game/blob/main/images/03-nibu-clap1.png?raw=true",
            clap2: "https://github.com/taltalhobby/shiritori-game/blob/main/images/04-nibu-clap2.png?raw=true",
            correct: "https://github.com/taltalhobby/shiritori-game/blob/main/images/05-nibu-correct.png?raw=true",
            goal: "https://github.com/taltalhobby/shiritori-game/blob/main/images/06-nibu-tartarchicken.png?raw=true",
            fail: "https://github.com/taltalhobby/shiritori-game/blob/main/images/07-nibu-fail.png?raw=true"
        };

        // ãã®ä»–ã®ç”»åƒ
        const GAME_IMAGES = {
            gameOver: "https://github.com/taltalhobby/shiritori-game/blob/main/images/11-kasuga-seal.png?raw=true",
            clear: "https://github.com/taltalhobby/shiritori-game/blob/main/images/91-tartarchicken-high-quality.png?raw=true"
        };

        let clapToggle = false; // æ‹æ‰‹ç”»åƒåˆ‡ã‚Šæ›¿ãˆç”¨
        const preloadedImages = {}; // ãƒ—ãƒªãƒ­ãƒ¼ãƒ‰ã—ãŸç”»åƒã‚’ä¿æŒ

        // å…¨ç”»åƒãƒ—ãƒªãƒ­ãƒ¼ãƒ‰ï¼ˆãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«å®Ÿè¡Œï¼‰
        function preloadAllImages() {
            // ã«ã¶ã¡ã‚ƒã‚“ç”»åƒ
            for (const [key, url] of Object.entries(NIBU_IMAGES)) {
                const img = new Image();
                img.src = url;
                preloadedImages[key] = img;
            }
            // ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼ãƒ»ã‚¯ãƒªã‚¢ç”»åƒ
            for (const [key, url] of Object.entries(GAME_IMAGES)) {
                const img = new Image();
                img.src = url;
                preloadedImages[key] = img;
            }
        }

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«ãƒ—ãƒªãƒ­ãƒ¼ãƒ‰
        window.addEventListener('DOMContentLoaded', preloadAllImages);

        // ç”»åƒåˆ‡ã‚Šæ›¿ãˆï¼ˆactiveã‚¯ãƒ©ã‚¹ã®ä»˜ã‘æ›¿ãˆã®ã¿ï¼‰
        function setNibuImage(imageKey) {
            const container = document.getElementById('nibu-char-container');
            if (!container) return;

            // å…¨ç”»åƒã‹ã‚‰activeã‚’å¤–ã™
            container.querySelectorAll('.nibu-img').forEach(img => {
                img.classList.remove('active');
            });

            // æŒ‡å®šã—ãŸç”»åƒã«activeã‚’ä»˜ã‘ã‚‹
            const targetImg = container.querySelector(`[data-state="${imageKey}"]`);
            if (targetImg) {
                targetImg.classList.add('active');
            }
        }

        // ãƒã‚¦ãƒ³ã‚¹åˆ¶å¾¡ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯ä¸Šã€è£æ‹ã§ä¸‹ã«ï¼‰
        function setNibuBounce(isDown) {
            const container = document.getElementById('nibu-char-container');
            if (!container) return;
            if (isDown) {
                container.classList.add('down');
            } else {
                container.classList.remove('down');
            }
        }

        // ========== Web Audio API ==========
        let audioCtx = null;

        function initAudio() {
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        }

        // ã‚¤ãƒ³ãƒˆãƒ­ç”¨ã€Œãƒãƒƒã€çŸ­ã„å˜éŸ³ï¼ˆA = 440Hzï¼‰
        function playPop() {
            if (!audioCtx) return;
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain);
            gain.connect(audioCtx.destination);

            osc.type = 'square';
            osc.frequency.setValueAtTime(440, audioCtx.currentTime); // A4

            gain.gain.setValueAtTime(0.3, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.08);

            osc.start(audioCtx.currentTime);
            osc.stop(audioCtx.currentTime + 0.08);
        }

        // ã‚¤ãƒ³ãƒˆãƒ­4æ‹ç›®ç”¨ã€Œãƒãƒ¼ãƒ³ã€é•·ã„å˜éŸ³ï¼ˆã‚ªã‚¯ã‚¿ãƒ¼ãƒ–ä¸Š A = 880Hzï¼‰
        function playPopHigh() {
            if (!audioCtx) return;
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain);
            gain.connect(audioCtx.destination);

            osc.type = 'square';
            osc.frequency.setValueAtTime(880, audioCtx.currentTime); // A5

            gain.gain.setValueAtTime(0.35, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.25);

            osc.start(audioCtx.currentTime);
            osc.stop(audioCtx.currentTime + 0.25);
        }

        // ã‚»ãƒ¬ã‚¯ãƒˆç”¨ ã‚³ãƒ¼ãƒ‰é€²è¡Œå¯¾å¿œå’ŒéŸ³
        // ã‚µã‚¤ã‚¯ãƒ«1: A (A, C#, E)
        // ã‚µã‚¤ã‚¯ãƒ«2: C7 (C, E, G, Bb)
        // ã‚µã‚¤ã‚¯ãƒ«3: Fmaj7 (F, A, C, E)
        // ã‚µã‚¤ã‚¯ãƒ«4: 1-2æ‹ç›® E7sus4 (E, A, B, D), 3-4æ‹ç›® E7 (E, G#, B, D)
        function playChord() {
            if (!audioCtx) return;

            const chords = {
                Aadd9: [110, 494, 554, 659],      // A2(ãƒ«ãƒ¼ãƒˆ), B4, C#5, E5
                Cmaj7: [131, 392, 494, 523, 659], // C3(ãƒ«ãƒ¼ãƒˆ), G4, B4, C5, E5ï¼ˆè»¢å›å½¢ï¼‰
                Fmaj7: [175, 349, 440, 523, 659], // F3(ãƒ«ãƒ¼ãƒˆ), F4, A4, C5, E5
                E7sus4: [165, 440, 494, 587, 659], // E3(ãƒ«ãƒ¼ãƒˆ), A4, B4, D5, E5ï¼ˆè»¢å›å½¢ï¼‰
                E7: [165, 415, 494, 587, 659]      // E3(ãƒ«ãƒ¼ãƒˆ), G#4, B4, D5, E5ï¼ˆè»¢å›å½¢ï¼‰
            };

            const cycleIndex = cycleCount % 4;
            let frequencies;

            if (cycleIndex === 0) {
                frequencies = chords.Aadd9;
            } else if (cycleIndex === 1) {
                frequencies = chords.Cmaj7;
            } else if (cycleIndex === 2) {
                frequencies = chords.Fmaj7;
            } else {
                // ã‚µã‚¤ã‚¯ãƒ«4: 1-2æ‹ç›®ã¯E7sus4ã€3-4æ‹ç›®ã¯E7
                const beatInMeasure = ((currentBeat - 1) % 4) + 1;
                frequencies = (beatInMeasure <= 2) ? chords.E7sus4 : chords.E7;
            }

            frequencies.forEach(freq => {
                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();
                osc.connect(gain);
                gain.connect(audioCtx.destination);

                osc.type = 'square';
                osc.frequency.setValueAtTime(freq, audioCtx.currentTime);

                gain.gain.setValueAtTime(0.12, audioCtx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.12);

                osc.start(audioCtx.currentTime);
                osc.stop(audioCtx.currentTime + 0.12);
            });
        }

        // ã‚¯ãƒ©ãƒƒãƒ—ï¼ˆ2å°ç¯€ç›®ï¼‰
        function playClap() {
            if (!audioCtx) return;
            const bufferSize = audioCtx.sampleRate * 0.08;
            const buffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
            const data = buffer.getChannelData(0);

            for (let i = 0; i < bufferSize; i++) {
                data[i] = (Math.random() * 2 - 1) * Math.pow(1 - i / bufferSize, 3);
            }

            const noise = audioCtx.createBufferSource();
            noise.buffer = buffer;

            const filter = audioCtx.createBiquadFilter();
            filter.type = 'highpass';
            filter.frequency.value = 1200;

            const gain = audioCtx.createGain();
            gain.gain.setValueAtTime(0.5, audioCtx.currentTime);

            noise.connect(filter);
            filter.connect(gain);
            gain.connect(audioCtx.destination);

            noise.start();
        }

        // ãƒ”ãƒ³ãƒãƒ³éŸ³ï¼ˆæ­£è§£ï¼‰ã€Œã´ã‚“â†‘ã½ã‚“â†“ã€
        function playPinpon() {
            if (!audioCtx) return;
            // 1éŸ³ç›®ï¼ˆé«˜ã„éŸ³ï¼‰
            const osc1 = audioCtx.createOscillator();
            const gain1 = audioCtx.createGain();
            osc1.connect(gain1);
            gain1.connect(audioCtx.destination);
            osc1.type = 'sine';
            osc1.frequency.setValueAtTime(1100, audioCtx.currentTime);
            gain1.gain.setValueAtTime(0.4, audioCtx.currentTime);
            gain1.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.15);
            osc1.start(audioCtx.currentTime);
            osc1.stop(audioCtx.currentTime + 0.15);

            // 2éŸ³ç›®ï¼ˆä½ã„éŸ³ï¼‰
            const osc2 = audioCtx.createOscillator();
            const gain2 = audioCtx.createGain();
            osc2.connect(gain2);
            gain2.connect(audioCtx.destination);
            osc2.type = 'sine';
            osc2.frequency.setValueAtTime(880, audioCtx.currentTime + 0.15);
            gain2.gain.setValueAtTime(0, audioCtx.currentTime);
            gain2.gain.setValueAtTime(0.4, audioCtx.currentTime + 0.15);
            gain2.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.35);
            osc2.start(audioCtx.currentTime + 0.15);
            osc2.stop(audioCtx.currentTime + 0.35);
        }

        // ãƒ–ãƒ–ãƒ¼éŸ³ï¼ˆä¸æ­£è§£ï¼‰ã€Œã¶â†’ã¶ãƒ¼â†’ã€
        function playBubu() {
            if (!audioCtx) return;
            // 1éŸ³ç›®
            const osc1 = audioCtx.createOscillator();
            const gain1 = audioCtx.createGain();
            osc1.connect(gain1);
            gain1.connect(audioCtx.destination);
            osc1.type = 'sawtooth';
            osc1.frequency.setValueAtTime(120, audioCtx.currentTime);
            gain1.gain.setValueAtTime(0.35, audioCtx.currentTime);
            gain1.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.15);
            osc1.start(audioCtx.currentTime);
            osc1.stop(audioCtx.currentTime + 0.15);

            // 2éŸ³ç›®ï¼ˆé•·ã‚ï¼‰
            const osc2 = audioCtx.createOscillator();
            const gain2 = audioCtx.createGain();
            osc2.connect(gain2);
            gain2.connect(audioCtx.destination);
            osc2.type = 'sawtooth';
            osc2.frequency.setValueAtTime(100, audioCtx.currentTime + 0.18);
            gain2.gain.setValueAtTime(0, audioCtx.currentTime);
            gain2.gain.setValueAtTime(0.35, audioCtx.currentTime + 0.18);
            gain2.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.5);
            osc2.start(audioCtx.currentTime + 0.18);
            osc2.stop(audioCtx.currentTime + 0.5);
        }

        // ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼éŸ³ï¼ˆAdim - ä½ã‚ï¼‰
        function playGameOver() {
            if (!audioCtx) return;
            // Adim = A, C, Ebï¼ˆä½ã‚ï¼‰
            const frequencies = [220, 262, 311]; // A3, C4, Eb4

            frequencies.forEach(freq => {
                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();
                osc.connect(gain);
                gain.connect(audioCtx.destination);

                osc.type = 'sawtooth';
                osc.frequency.setValueAtTime(freq, audioCtx.currentTime);

                gain.gain.setValueAtTime(0.15, audioCtx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.8);

                osc.start(audioCtx.currentTime);
                osc.stop(audioCtx.currentTime + 0.8);
            });
        }
        function playFanfare() {
            if (!audioCtx) return;

            // Aãƒ¡ã‚¸ãƒ£ãƒ¼å’ŒéŸ³ã®ã‚¢ãƒ«ãƒšã‚¸ã‚ª + æœ€å¾Œã«è¯ã‚„ã‹ãªAãƒ¡ã‚¸ãƒ£ãƒ¼7ã‚³ãƒ¼ãƒ‰
            const sequence = [
                { time: 0, freqs: [440] },           // A4
                { time: 0.12, freqs: [554] },        // C#5
                { time: 0.24, freqs: [659] },        // E5
                { time: 0.36, freqs: [880] },        // A5
                { time: 0.55, freqs: [440, 554, 659, 831, 880] } // Amaj7 + A5ï¼ˆæœ€å¾Œã®å’ŒéŸ³ï¼‰
            ];

            sequence.forEach(({ time, freqs }) => {
                freqs.forEach(freq => {
                    const osc = audioCtx.createOscillator();
                    const gain = audioCtx.createGain();
                    osc.connect(gain);
                    gain.connect(audioCtx.destination);

                    osc.type = 'square';
                    osc.frequency.setValueAtTime(freq, audioCtx.currentTime + time);

                    const duration = (freqs.length > 1) ? 0.6 : 0.2;
                    const volume = (freqs.length > 1) ? 0.08 : 0.25;

                    gain.gain.setValueAtTime(0, audioCtx.currentTime);
                    gain.gain.setValueAtTime(volume, audioCtx.currentTime + time);
                    gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + time + duration);

                    osc.start(audioCtx.currentTime + time);
                    osc.stop(audioCtx.currentTime + time + duration);
                });
            });
        }

        // ã‚¹ã‚¿ãƒ¼ãƒˆéŸ³ã€Œãƒ”ãƒ­ãƒ³ã€
        function playStartSound() {
            if (!audioCtx) return;

            const osc1 = audioCtx.createOscillator();
            const gain1 = audioCtx.createGain();
            osc1.connect(gain1);
            gain1.connect(audioCtx.destination);
            osc1.type = 'sine';
            osc1.frequency.setValueAtTime(880, audioCtx.currentTime); // A5
            gain1.gain.setValueAtTime(0.3, audioCtx.currentTime);
            gain1.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.15);
            osc1.start(audioCtx.currentTime);
            osc1.stop(audioCtx.currentTime + 0.15);

            const osc2 = audioCtx.createOscillator();
            const gain2 = audioCtx.createGain();
            osc2.connect(gain2);
            gain2.connect(audioCtx.destination);
            osc2.type = 'sine';
            osc2.frequency.setValueAtTime(1320, audioCtx.currentTime + 0.12); // E6
            gain2.gain.setValueAtTime(0, audioCtx.currentTime);
            gain2.gain.setValueAtTime(0.3, audioCtx.currentTime + 0.12);
            gain2.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.35);
            osc2.start(audioCtx.currentTime + 0.12);
            osc2.stop(audioCtx.currentTime + 0.35);
        }

        // ãƒ€ãƒŸãƒ¼é¸æŠè‚¢ã‚’è¡¨ç¤ºï¼ˆUIå›ºå®šç”¨ï¼‰
        function showDummyChoices() {
            const container = document.getElementById('choices');
            container.innerHTML = '';
            for (let i = 0; i < 4; i++) {
                const btn = document.createElement('button');
                btn.className = 'choice-btn';
                btn.innerHTML = '<span class="first-char">&nbsp;</span><span class="rest-chars">&nbsp;&nbsp;&nbsp;</span>';
                btn.disabled = true;
                btn.style.visibility = 'hidden';
                container.appendChild(btn);
            }
        }

        // ========== ã‚²ãƒ¼ãƒ ãƒ­ã‚¸ãƒƒã‚¯ ==========
        // ã—ã‚Šã¨ã‚Šã§ç¹‹ãŒã‚‹æ–‡å­—ã‚’è¿”ã™ï¼ˆé¸æŠè‚¢ç”Ÿæˆãƒ»æ­£èª¤åˆ¤å®šç”¨ï¼‰
        function getLastChar(word) {
            let last = word.slice(-1);
            // é•·éŸ³ã®å ´åˆã¯å‰ã®æ–‡å­—
            if (last === "ãƒ¼") last = word.slice(-2, -1);
            // å°ã•ã„æ–‡å­—ã¯å¤§ãã„æ–‡å­—ã«å¤‰æ›
            const smallToBig = { 'ã': 'ã‚', 'ãƒ': 'ã„', 'ã…': 'ã†', 'ã‡': 'ãˆ', 'ã‰': 'ãŠ', 'ã‚ƒ': 'ã‚„', 'ã‚…': 'ã‚†', 'ã‚‡': 'ã‚ˆ', 'ã£': 'ã¤' };
            return smallToBig[last] || last;
        }

        // ä¸­å¤®å††ã«è¡¨ç¤ºã™ã‚‹HTML
        // ç‰¹æ®Šè¡¨ç¤º: é•·éŸ³ã€Œãƒ¼ã€ã¨ã€Œã¾ã£ã¡ã‚ƒâ†’ã¡ã‚ƒã°ã€ã‚³ãƒ³ãƒœã®ã¿
        function getCenterCharDisplay(word, isSelected = false) {
            // ã€Œã¾ã£ã¡ã‚ƒã€ã¯é¸æŠå‰ã¯ã€Œã‚„ã€ã€é¸æŠå¾Œï¼ˆã¡ã‚ƒã°é¸æŠæ™‚ï¼‰ã¯ã€Œã¡ã‚ƒã€
            if (word === "ã¾ã£ã¡ã‚ƒ") {
                if (isSelected) {
                    return `ã¡<span class="sub-char">ã‚ƒ</span>`;
                } else {
                    return "ã‚„";
                }
            }

            const last = word.slice(-1);

            // é•·éŸ³ã§çµ‚ã‚ã‚‹å ´åˆ: ã€ŒãŸã€+å°ã•ã„ã€Œãƒ¼ã€
            if (last === "ãƒ¼") {
                const mainChar = word.slice(-2, -1);
                return `${mainChar}<span class="sub-char">ãƒ¼</span>`;
            }

            // å°ã•ã„æ–‡å­—ã¯å¾“æ¥é€šã‚Šå¤§ãã„æ–‡å­—ã«å¤‰æ›
            const smallToBig = { 'ã': 'ã‚', 'ãƒ': 'ã„', 'ã…': 'ã†', 'ã‡': 'ãˆ', 'ã‰': 'ãŠ', 'ã‚ƒ': 'ã‚„', 'ã‚…': 'ã‚†', 'ã‚‡': 'ã‚ˆ', 'ã£': 'ã¤' };
            return smallToBig[last] || last;
        }

        // å¹ãå‡ºã—å·¦å´ã«è¡¨ç¤ºã™ã‚‹ã€Œæœ«å°¾æ–‡å­—ã‚’é™¤å»ã—ãŸå˜èªã€ã‚’è¿”ã™
        function getWordWithoutLastChar(word) {
            // ã€Œã¾ã£ã¡ã‚ƒã€ã¯é¸æŠå‰ã¯ä¸­å¤®ã«ã€Œã‚„ã€ã ã‘ãªã®ã§1æ–‡å­—é™¤å»
            if (word === "ã¾ã£ã¡ã‚ƒ") {
                return "ã¾ã£ã¡";
            }
            const last = word.slice(-1);
            // é•·éŸ³ã€Œãƒ¼ã€ã®å ´åˆã¯ã€Œãƒ¼ã€ã¨ãã®å‰ã®æ–‡å­—ã‚’é™¤å»ï¼ˆä¸­å¤®å††ã«2æ–‡å­—è¡¨ç¤ºï¼‰
            if (last === "ãƒ¼") {
                return word.slice(0, -2);
            }
            // å°ã•ã„æ–‡å­—ã¯å¾“æ¥é€šã‚Š1æ–‡å­—é™¤å»ï¼ˆä¸­å¤®å††ã¯å¤§ãã„æ–‡å­—ã§è¡¨ç¤ºï¼‰
            // é€šå¸¸ã®æ–‡å­—ã‚‚ãã®ã¾ã¾1æ–‡å­—é™¤å»
            return word.slice(0, -1);
        }

        function generateChoices() {
            let lastChar = getLastChar(currentWord);
            let correctPicks = [];

            // ã‚³ãƒ³ãƒœãƒã‚§ãƒ¼ãƒ³ã®æ¬¡ã®å˜èªãŒã‚ã‚Œã°å„ªå…ˆ
            if (combo[currentWord]) {
                correctPicks.push(combo[currentWord]);
            }

            // ã‚³ãƒ³ãƒœã‚¹ã‚¿ãƒ¼ã‚¿ãƒ¼ãŒã‚ã‚Œã°è¿½åŠ ï¼ˆã¾ã£ã¡ã‚ƒã€ã©ãƒ¼ãªã¤ã€ã†ãŸã€ã„ãŸç­‰ï¼‰
            if (comboStarters[lastChar] && !correctPicks.includes(comboStarters[lastChar])) {
                correctPicks.push(comboStarters[lastChar]);
            }

            // ã€ŒãŸã€ãŒæ¥ãŸã‚‰ã€ŒãŸã‚‹ãŸã‚‹ã¡ãã‚“ã€ã‚’1å›ç›®ã‹ã‚‰å‡ºã™
            if (lastChar === "ãŸ" && !correctPicks.includes("ãŸã‚‹ãŸã‚‹ã¡ãã‚“")) {
                correctPicks.push("ãŸã‚‹ãŸã‚‹ã¡ãã‚“");
            }

            // é€šå¸¸ã®å˜èªã‹ã‚‰æ®‹ã‚Šã‚’è£œå……ï¼ˆæœ€å¤§2ã¤ã¾ã§ï¼‰
            const targets = [...(wordDict[lastChar] || wordDict["ã‚"])].sort(() => Math.random() - 0.5);
            for (let t of targets) {
                if (correctPicks.length >= 2) break;
                if (!correctPicks.includes(t)) correctPicks.push(t);
            }

            // ä¸æ­£è§£é¸æŠè‚¢ã‚’æº–å‚™
            let incorrectPicks = [];

            // è² ã‘ã‚³ãƒ³ãƒœã‚¹ã‚¿ãƒ¼ã‚¿ãƒ¼ãŒã‚ã‚Œã°å„ªå…ˆçš„ã«è¿½åŠ 
            if (loseComboStarters[lastChar] && !correctPicks.includes(loseComboStarters[lastChar])) {
                incorrectPicks.push(loseComboStarters[lastChar]);
            }

            // è² ã‘ã‚³ãƒ³ãƒœãƒã‚§ãƒ¼ãƒ³ã®æ¬¡ã®å˜èªãŒã‚ã‚Œã°è¿½åŠ 
            if (combo[currentWord] && !correctPicks.includes(combo[currentWord]) && !incorrectPicks.includes(combo[currentWord])) {
                // ã“ã®å ´åˆã¯correctPicksã«å…¥ã£ã¦ã„ã‚‹ã¯ãšãªã®ã§ã‚¹ã‚­ãƒƒãƒ—
            }

            // æ®‹ã‚Šã®ä¸æ­£è§£é¸æŠè‚¢ã‚’ãƒ©ãƒ³ãƒ€ãƒ ã«è¿½åŠ 
            const allWords = Object.values(wordDict).flat();
            while (incorrectPicks.length < 2) {
                const wrong = allWords[Math.floor(Math.random() * allWords.length)];
                // æ­£è§£ã«ãªã‚‰ãªã„ã“ã¨ã‚’ç¢ºèª
                const startsWithLastChar = wrong.startsWith(lastChar) ||
                    (lastChar === "ã¡" && wrong.startsWith("ã¡ã‚ƒ"));
                const isComboWord = wrong === combo[currentWord] || wrong === comboStarters[lastChar];
                const isLoseComboWord = wrong === loseComboStarters[lastChar];
                if (!startsWithLastChar && !isComboWord && !isLoseComboWord && !incorrectPicks.includes(wrong) && !correctPicks.includes(wrong)) {
                    incorrectPicks.push(wrong);
                }
            }

            return [...correctPicks, ...incorrectPicks].sort(() => Math.random() - 0.5);
        }

        function checkAnswer(selected) {
            const lastChar = getLastChar(currentWord);

            // ã€ŒãŸã‚‹ãŸã‚‹ã¡ãã‚“ã€ã¯ã€ŒãŸã€ã§å§‹ã¾ã‚‹ã®ã§ã€lastCharãŒã€ŒãŸã€ã®æ™‚ã®ã¿ã‚´ãƒ¼ãƒ«
            if (selected === "ãŸã‚‹ãŸã‚‹ã¡ãã‚“" && lastChar === "ãŸ") {
                return { correct: true, isGoal: true };
            }

            let isCorrect = false;

            // ã‚³ãƒ³ãƒœãƒã‚§ãƒ¼ãƒ³ã®æ¬¡ã®å˜èªã¨ã—ã¦æ­£è§£
            if (selected === combo[currentWord]) {
                isCorrect = true;
            }
            // ã‚³ãƒ³ãƒœã‚¹ã‚¿ãƒ¼ã‚¿ãƒ¼ã¨ã—ã¦æ­£è§£
            else if (selected === comboStarters[lastChar]) {
                isCorrect = true;
            }
            // é€šå¸¸ã®ã—ã‚Šã¨ã‚Šã¨ã—ã¦æ­£è§£ï¼ˆlastCharã§å§‹ã¾ã‚‹ï¼‰
            else if (selected.startsWith(lastChar)) {
                isCorrect = true;
            }
            // ã€Œã¡ã€ã®å ´åˆã¯ã€Œã¡ã‚ƒã€ã§å§‹ã¾ã‚‹å˜èªã‚‚æ­£è§£
            else if (lastChar === "ã¡" && selected.startsWith("ã¡ã‚ƒ")) {
                isCorrect = true;
            }

            if (isCorrect && selected.endsWith("ã‚“")) {
                return { correct: false, isGoal: false };
            }

            return { correct: isCorrect, isGoal: false };
        }

        // ========== UIæ“ä½œ ==========
        // ãƒªã‚ºãƒ ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ã¯å‰Šé™¤ã•ã‚ŒãŸãŸã‚ã€ã“ã®é–¢æ•°ã¯ç©ºã®ã¾ã¾ï¼ˆäº’æ›æ€§ã®ãŸã‚æ®‹ã™ï¼‰
        function updateBeatIndicator(beat) {
            // å»ƒæ­¢: ãƒªã‚ºãƒ ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ã¯è¡¨ç¤ºã—ãªã„
        }

        // ã—ã£ã½ã®å‘ãã‚’åˆ¶å¾¡ã™ã‚‹é–¢æ•°
        function setTailDirection(direction) {
            const circle = document.getElementById('next-char');
            circle.classList.remove('tail-left', 'tail-right');
            if (direction === 'left') {
                circle.classList.add('tail-left');
            } else if (direction === 'right') {
                circle.classList.add('tail-right');
            }
        }

        function updateTimeBar() {
            const barLeft = document.getElementById('time-bar-left');
            const barRight = document.getElementById('time-bar-right');

            // å·¦å³ã‹ã‚‰ä¸­å¤®ã¸æ¸›å°‘ï¼ˆå„ãƒãƒ¼ã¯50%ãŒæœ€å¤§ï¼‰
            const halfWidth = (timeBarWidth / 2);
            barLeft.style.width = halfWidth + '%';
            barRight.style.width = halfWidth + '%';

            // è‰²å¤‰æ›´
            barLeft.classList.remove('warning', 'danger');
            barRight.classList.remove('warning', 'danger');
            if (timeBarWidth <= 25) {
                barLeft.classList.add('danger');
                barRight.classList.add('danger');
            } else if (timeBarWidth <= 50) {
                barLeft.classList.add('warning');
                barRight.classList.add('warning');
            }
        }

        function startTimeBar() {
            timeBarWidth = 100;
            updateTimeBar();
            const decrementPerTick = 100 / (4 * (BEAT_DURATION / 50)); // 1å°ç¯€ã§100%æ¸›å°‘
            timeBarInterval = setInterval(() => {
                if (selectedWord !== null) return; // é¸æŠæ¸ˆã¿ãªã‚‰åœæ­¢
                timeBarWidth = Math.max(0, timeBarWidth - (100 / (4 * (BEAT_DURATION / 50))));
                updateTimeBar();
            }, 50);
        }

        function stopTimeBar() {
            if (timeBarInterval) {
                clearInterval(timeBarInterval);
                timeBarInterval = null;
            }
        }

        // å¹ãå‡ºã—ã«æ–‡å­—ã‚’ã‚»ãƒƒãƒˆï¼ˆé•·ä½“ã§åã‚ã‚‹ï¼‰
        function setSpeechText(elementId, text) {
            const el = document.getElementById(elementId);

            // å†…éƒ¨ã«spanè¦ç´ ã‚’ä½œæˆã—ã¦ãƒ†ã‚­ã‚¹ãƒˆã‚’é…ç½®
            const span = document.createElement('span');
            span.textContent = text;
            span.style.display = 'inline-block';
            span.style.whiteSpace = 'nowrap';
            el.innerHTML = '';
            el.appendChild(span);

            // æç”»å¾Œã«å¹…ã‚’æ¸¬å®šã—ã¦é•·ä½“é©ç”¨
            requestAnimationFrame(() => {
                const containerWidth = el.clientWidth - 16; // paddingåˆ†ã‚’å¼•ã
                const textWidth = span.offsetWidth;

                if (textWidth > containerWidth && textWidth > 0) {
                    const scale = containerWidth / textWidth;
                    // æœ€å°0.5ã¾ã§ã®é•·ä½“
                    const scaleX = Math.max(0.5, scale);
                    span.style.transform = `scaleX(${scaleX})`;
                    // transform-originã‚’é…ç½®ã«åˆã‚ã›ã‚‹
                    if (elementId === 'speech-left') {
                        span.style.transformOrigin = 'right center';
                    } else {
                        span.style.transformOrigin = 'left center';
                    }
                }
            });
        }

        function updateChoices(choices) {
            const container = document.getElementById('choices');
            container.innerHTML = '';

            const nextCharDisplay = getCenterCharDisplay(currentWord);
            document.getElementById('next-char').innerHTML = nextCharDisplay;

            // å·¦å¹ãå‡ºã—ã«è¡¨ç¤ºã™ã‚‹å˜èªï¼ˆé•·éŸ³ãƒ»å°æ–‡å­—å¯¾å¿œï¼‰
            const leftWord = getWordWithoutLastChar(currentWord);
            setSpeechText('speech-left', leftWord);

            choices.forEach(word => {
                const btn = document.createElement('button');
                btn.className = 'choice-btn';
                const firstChar = word.charAt(0);
                const restChars = word.slice(1);
                btn.innerHTML = `<span class="first-char">${firstChar}</span><span class="rest-chars">${restChars}</span>`;
                btn.onclick = () => selectChoice(word, btn);
                container.appendChild(btn);
            });
        }

        function selectChoice(word, btn) {
            if (!isPlaying || gamePhase !== "select") return;
            // æ—¢ã«é¸æŠæ¸ˆã¿ãªã‚‰ä½•ã‚‚ã—ãªã„
            if (selectedWord !== null) return;

            document.querySelectorAll('.choice-btn').forEach(b => b.classList.remove('selected'));
            btn.classList.add('selected');
            selectedWord = word;

            // é¸æŠå¾Œã¯å…¨ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–ï¼ˆé¸ã³ç›´ã—é˜²æ­¢ï¼‰
            document.querySelectorAll('.choice-btn').forEach(b => {
                b.disabled = true;
            });
        }

        function hideChoices() {
            document.getElementById('choices').innerHTML = '';
            document.getElementById('next-char').textContent = '';
        }

        function disableChoices() {
            document.querySelectorAll('.choice-btn').forEach(btn => {
                btn.disabled = true;
            });
        }

        function pulseCharacter() {
            const container = document.getElementById('nibu-char-container');
            if (!container) return;
            container.classList.remove('pulse');
            void container.offsetWidth;
            container.classList.add('pulse');
        }

        // ========== ãƒªã‚ºãƒ ã‚¨ãƒ³ã‚¸ãƒ³ï¼ˆ2å°ç¯€ = 8æ‹ï¼‰ ==========
        let BPM = 120;
        let BEAT_DURATION = 60000 / BPM; // 500ms

        // ãƒ›ãƒ¯ã‚¤ãƒˆã‚¦ã‚©ãƒƒã‚·ãƒ¥åˆ¶å¾¡
        function setWhitewash(side) {
            const left = document.getElementById('speech-left');
            const right = document.getElementById('speech-right');
            left.classList.remove('whitewash');
            right.classList.remove('whitewash');
            if (side === 'right') {
                right.classList.add('whitewash');
            } else if (side === 'left') {
                left.classList.add('whitewash');
            }
        }

        function startRhythm() {
            currentBeat = 0;
            nextBeat();
        }

        function nextBeat() {
            if (!isPlaying) return;

            currentBeat = (currentBeat % 8) + 1;
            updateBeatIndicator(currentBeat);

            if (gamePhase === "intro") {
                // ã‚¤ãƒ³ãƒˆãƒ­: 0-1ï½0-4 æœ€åˆã®å˜èªã®ã¿
                // 1ã‚¿ãƒ¼ãƒ³ç›®ã®ã‚¤ãƒ³ãƒˆãƒ­ã€œselectãƒ•ã‚§ãƒ¼ã‚ºçµ‚äº†ã¾ã§ã¯ã—ã£ã½ã¯å·¦ï¼ˆæç¤ºäººå´ï¼‰
                setTailDirection('left');
                setWhitewash('right'); // å³å´ã‚’ãƒ›ãƒ¯ã‚¤ãƒˆã‚¦ã‚©ãƒƒã‚·ãƒ¥
                setNibuImage('waiting'); // å¾…æ©Ÿç”»åƒ

                // ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ãƒ†ãƒ­ãƒƒãƒ—ã‚’è¡¨ç¤º
                const countdownEl = document.getElementById('countdown-overlay');
                const countdownTexts = { 1: '3', 2: '2', 3: '1', 4: 'GO!' };
                countdownEl.textContent = countdownTexts[currentBeat];
                countdownEl.classList.remove('show');
                void countdownEl.offsetWidth; // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ãƒªã‚»ãƒƒãƒˆ
                countdownEl.classList.add('show');

                if (currentBeat === 4) {
                    playPopHigh(); // 4æ‹ç›®ã¯ã€Œãƒãƒ¼ãƒ³ã€
                    // GO!ã‚’å°‘ã—é•·ãè¡¨ç¤ºã—ã¦ã‹ã‚‰æ¶ˆã™
                    setTimeout(() => {
                        countdownEl.classList.remove('show');
                    }, BEAT_DURATION * 0.8);
                } else {
                    playPop(); // 1-3æ‹ç›®ã¯ã€Œãƒãƒƒã€
                }
            } else if (gamePhase === "select") {
                // 1å°ç¯€ç›®: é¸æŠè‚¢é¸æŠ (æ‹1ï½4)
                setWhitewash('right'); // å³å´ã‚’ãƒ›ãƒ¯ã‚¤ãƒˆã‚¦ã‚©ãƒƒã‚·ãƒ¥
                // 1ã‚¿ãƒ¼ãƒ³ç›®ã¯ã—ã£ã½ã‚’å·¦ã«ä¿æŒã€2ã‚¿ãƒ¼ãƒ³ç›®ä»¥é™ã¯å³
                if (isFirstTurn) {
                    setTailDirection('left');
                } else {
                    setTailDirection('right');
                }
                if ((currentBeat === 1 || currentBeat === 5) && !choicesShown) {
                    // é¸æŠãƒ•ã‚§ãƒ¼ã‚ºã®é–‹å§‹ï¼ˆ1-1ï¼‰
                    // ã‚¿ãƒ¼ãƒ³è¡¨ç¤ºã‚’æ›´æ–°
                    document.getElementById('score').textContent = score;
                    // å³å¹ãå‡ºã—ã‚’ã‚¯ãƒªã‚¢ï¼ˆ1-1ã‹ã‚‰ã¯ç©ºæ¬„ã€2-4çµ‚ã‚ã‚Šã¾ã§ã¯å‰ã®ã‚¿ãƒ¼ãƒ³ã®å›ç­”ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ãŸï¼‰
                    document.getElementById('speech-right').textContent = '';
                    updateChoices(generateChoices());
                    startTimeBar();
                    selectedWord = null;
                    choicesShown = true;
                    // ãƒãƒ¼ã‚¯ã‚’éè¡¨ç¤º
                    document.getElementById('judgment-mark').className = 'judgment-mark';
                }
                setNibuImage('request'); // ãƒªã‚¯ã‚¨ã‚¹ãƒˆç”»åƒ
                // è¡¨æ‹ã§ä¸‹ã€0.5æ‹å¾Œã«ä¸Šï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰ã«æˆ»ã‚‹
                setNibuBounce(true); // ä¸‹ä½ç½®
                setTimeout(() => {
                    if (gamePhase === 'select' && isPlaying) {
                        setNibuBounce(false); // ä¸Šä½ç½®ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰
                    }
                }, BEAT_DURATION / 2);
                playChord(); // Aã‚³ãƒ¼ãƒ‰å’ŒéŸ³
            } else if (gamePhase === "answer") {
                // 2å°ç¯€ç›®: å›ç­”ãƒ»åˆå¦ (æ‹5ï½8 ã¾ãŸã¯ æ‹1ï½4ã§answerãƒ•ã‚§ãƒ¼ã‚ºãªã‚‰)
                // 2-1ã‹ã‚‰ã¯ã—ã£ã½ã‚’å³ï¼ˆã«ã¶ã¡ã‚ƒã‚“å´ï¼‰ã«å‘ã‘ã‚‹
                setTailDirection('right');
                setWhitewash('left'); // å·¦å´ã‚’ãƒ›ãƒ¯ã‚¤ãƒˆã‚¦ã‚©ãƒƒã‚·ãƒ¥
                playClap();
                // 2-1ã€2-2ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
                if (currentBeat === 1 || currentBeat === 2 || currentBeat === 5 || currentBeat === 6) {
                    if (selectedWord) {
                        // å›ç­”ãŒã‚ã‚‹å ´åˆï¼šæ‹æ‰‹ç”»åƒã‚’è¡¨æ‹/è£æ‹ã§åˆ‡ã‚Šæ›¿ãˆ
                        setNibuImage('clap1');
                        setTimeout(() => {
                            if (gamePhase === 'answer' && isPlaying) {
                                setNibuImage('clap2');
                            }
                        }, BEAT_DURATION / 2);
                    } else {
                        // å›ç­”ãŒãªã„å ´åˆï¼šrequestã‚¤ãƒ¡ãƒ¼ã‚¸ã¨ãƒã‚¦ãƒ³ã‚¹ã‚’ç¶™ç¶š
                        setNibuImage('request');
                        setNibuBounce(true); // ä¸‹ä½ç½®
                        setTimeout(() => {
                            if (gamePhase === 'answer' && isPlaying) {
                                setNibuBounce(false); // ä¸Šä½ç½®
                            }
                        }, BEAT_DURATION / 2);
                    }
                }
                if (currentBeat === 1 || currentBeat === 5) {
                    // 2-1: ã«ã¶ã¡ã‚ƒã‚“ãŒå›ç­”
                    processAnswer();
                }
                if (currentBeat === 3 || currentBeat === 7) {
                    // 2-3: åˆå¦ç™ºè¡¨
                    showJudgment();
                }
                if (currentBeat === 4 || currentBeat === 8) {
                    // 2-4çµ‚äº†ã€æ¬¡ã®ã‚µã‚¤ã‚¯ãƒ«ã¾ãŸã¯çµ‚äº†
                    if (pendingResult) {
                        handlePendingResult();
                    } else {
                        gamePhase = "select";
                    }
                }
            }

            // ãƒ•ã‚§ãƒ¼ã‚ºé·ç§»ãƒ­ã‚¸ãƒƒã‚¯
            // ã‚¤ãƒ³ãƒˆãƒ­æ‹4çµ‚äº†å¾Œ â†’ selecté–‹å§‹
            if (gamePhase === "intro" && currentBeat === 4) {
                setTimeout(() => {
                    if (isPlaying && gamePhase === "intro") {
                        gamePhase = "select";
                    }
                }, BEAT_DURATION - 10);
            }

            // selectæ‹4çµ‚äº†å¾Œ â†’ answeré–‹å§‹ï¼ˆchoicesShownãŒtrueã®æ™‚ã®ã¿ï¼‰
            if (gamePhase === "select" && choicesShown && (currentBeat === 4 || currentBeat === 8)) {
                setTimeout(() => {
                    if (isPlaying && gamePhase === "select") {
                        gamePhase = "answer";
                        choicesShown = false;
                        stopTimeBar();
                        disableChoices();
                    }
                }, BEAT_DURATION - 10);
            }

            if (isPlaying) {
                beatInterval = setTimeout(nextBeat, BEAT_DURATION);
            }
        }

        let pendingResult = null;

        function processAnswer() {
            if (!selectedWord) {
                // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆæ™‚ã¯ã«ã¶ã¡ã‚ƒã‚“å´ã«è¡¨ç¤º
                document.getElementById('speech-right').textContent = '...ï¼Ÿ';
                pendingResult = { type: 'timeout' };
                return;
            }

            // ã€Œã¾ã£ã¡ã‚ƒã€â†’ã€Œã¡ã‚ƒã°ã€ã®å ´åˆã®ç‰¹æ®Šå‡¦ç†
            if (currentWord === "ã¾ã£ã¡ã‚ƒ" && selectedWord === "ã¡ã‚ƒã°") {
                // ä¸­å¤®å††ã‚’ã€Œã¡ã‚ƒã€ã«æ›´æ–°
                document.getElementById('next-char').innerHTML = getCenterCharDisplay("ã¾ã£ã¡ã‚ƒ", true);
                // å·¦å¹ãå‡ºã—ã‚’ã€Œã¾ã£ã€ã«æ›´æ–°
                setSpeechText('speech-left', 'ã¾ã£');
                // å³å¹ãå‡ºã—ã¯ã€Œã°ï¼ã€
                setSpeechText('speech-right', 'ã°ï¼');
            } else {
                // ã«ã¶ã¡ã‚ƒã‚“ã®å›ç­”ã‚’å³å´ã®å¹ãå‡ºã—ã«è¡¨ç¤ºï¼ˆé ­æ–‡å­—ã¯ä¸­å¤®å††ã«ã‚ã‚‹ã®ã§é™¤å¤–ï¼‰
                const displayWord = selectedWord.slice(1) + 'ï¼';
                setSpeechText('speech-right', displayWord);
            }
            pulseCharacter();

            const result = checkAnswer(selectedWord);
            pendingResult = result;
        }

        function showJudgment() {
            if (!pendingResult) return;

            const mark = document.getElementById('judgment-mark');

            if (pendingResult.type === 'timeout') {
                playBubu();
                mark.textContent = 'âœ•';
                mark.className = 'judgment-mark wrong show';
                setNibuImage('fail'); // å¤±æ•—ç”»åƒ
            } else if (pendingResult.isGoal) {
                playPinpon(); // 2-3ã§ã¯æ­£è§£éŸ³
                mark.textContent = 'â—¯';
                mark.className = 'judgment-mark correct show';
                setNibuImage('goal'); // ã‚¿ãƒ«ã‚¿ãƒ«ãƒã‚­ãƒ³ç”»åƒ
            } else if (pendingResult.correct) {
                playPinpon();
                mark.textContent = 'â—¯';
                mark.className = 'judgment-mark correct show';
                score++;
                // è¡¨ç¤ºæ›´æ–°ã¯1-1ã§è¡Œã†ãŸã‚ã€ã“ã“ã§ã¯è¡Œã‚ãªã„
                currentWord = selectedWord;
                selectedWord = null;
                setNibuImage('correct'); // æ­£è§£ç”»åƒ
            } else {
                playBubu();
                mark.textContent = 'âœ•';
                mark.className = 'judgment-mark wrong show';
                setNibuImage('fail'); // å¤±æ•—ç”»åƒ
            }
        }

        function handlePendingResult() {
            if (!pendingResult) return;

            if (pendingResult.type === 'timeout') {
                pendingResult = null;
                setTimeout(() => endGame(false), BEAT_DURATION);
            } else if (pendingResult.isGoal) {
                pendingResult = null;
                setTimeout(() => endGame(true), BEAT_DURATION);
            } else if (pendingResult.correct) {
                // æ­£è§£ï¼šæ¬¡ã®ã‚µã‚¤ã‚¯ãƒ«ã¸
                pendingResult = null;
                gamePhase = "select";
                cycleCount++; // ã‚³ãƒ¼ãƒ‰é€²è¡Œã‚’é€²ã‚ã‚‹
                isFirstTurn = false; // 2ã‚¿ãƒ¼ãƒ³ç›®ä»¥é™ã¯ã—ã£ã½ãŒå³å‘ãã«ãªã‚‹
                // å³å¹ãå‡ºã—ã¯nextBeatã§æ–°ã—ã„ã‚¿ãƒ¼ãƒ³é–‹å§‹æ™‚ã«ã‚¯ãƒªã‚¢ã•ã‚Œã‚‹
            } else {
                // ä¸æ­£è§£
                pendingResult = null;
                setTimeout(() => endGame(false), BEAT_DURATION);
            }
        }

        // ========== ã‚²ãƒ¼ãƒ é–‹å§‹ãƒ»çµ‚äº† ==========
        function startGame(bpm) {
            initAudio();

            // ã‚¹ã‚¿ãƒ¼ãƒˆéŸ³ã€Œãƒ”ãƒ­ãƒ³ã€
            playStartSound();

            // ãƒ†ãƒ³ãƒè¨­å®šï¼ˆå¼•æ•°ã‹ã‚‰å—ã‘å–ã‚Šï¼‰
            BPM = bpm || 120;
            currentBPM = BPM; // ã‚¢ãƒ³ãƒ­ãƒƒã‚¯åˆ¤å®šç”¨ã«ä¿å­˜
            BEAT_DURATION = 60000 / BPM;

            const allWords = Object.values(wordDict).flat().filter(w => !w.endsWith('ã‚“'));
            currentWord = allWords[Math.floor(Math.random() * allWords.length)];

            score = 1;
            taVisitCount = 0;
            selectedWord = null;
            isPlaying = true;
            gamePhase = "intro";
            pendingResult = null;
            cycleCount = 0; // ã‚³ãƒ¼ãƒ‰é€²è¡Œãƒªã‚»ãƒƒãƒˆ
            isFirstTurn = true; // 1ã‚¿ãƒ¼ãƒ³ç›®ã®ãƒ•ãƒ©ã‚°ã‚’ãƒªã‚»ãƒƒãƒˆ

            // ã«ã¶ã¡ã‚ƒã‚“ç”»åƒã‚’å¾…æ©ŸçŠ¶æ…‹ã«ãƒªã‚»ãƒƒãƒˆ
            setNibuImage('waiting');
            setNibuBounce(false);

            document.getElementById('title-screen').style.display = 'none';
            document.getElementById('game-screen').style.display = 'flex';

            document.getElementById('score').textContent = '1';
            // æœ€åˆã®å˜èªã‚’æç¤ºäººå´ï¼ˆå·¦ï¼‰ã«è¡¨ç¤ºï¼ˆé•·éŸ³ãƒ»å°æ–‡å­—å¯¾å¿œï¼‰
            const nextCharDisplay = getCenterCharDisplay(currentWord);
            const leftWord = getWordWithoutLastChar(currentWord);
            setSpeechText('speech-left', leftWord);
            document.getElementById('speech-right').textContent = '';
            document.getElementById('next-char').innerHTML = nextCharDisplay;
            // ãƒ€ãƒŸãƒ¼é¸æŠè‚¢ã‚’4ã¤è¡¨ç¤ºï¼ˆ0-1ã‹ã‚‰UIã‚’å›ºå®šã™ã‚‹ãŸã‚ï¼‰
            showDummyChoices();
            // æ™‚é–“ãƒãƒ¼ã‚’ãƒªã‚»ãƒƒãƒˆ
            document.getElementById('time-bar-left').style.width = '50%';
            document.getElementById('time-bar-right').style.width = '50%';
            // ã—ã£ã½ã‚’å·¦ï¼ˆæç¤ºäººå´ï¼‰ã«å‘ã‘ã‚‹
            setTailDirection('left');
            // å³å´ã‚’ãƒ›ãƒ¯ã‚¤ãƒˆã‚¦ã‚©ãƒƒã‚·ãƒ¥ï¼ˆã‚¹ã‚¿ãƒ¼ãƒˆæ™‚ã‹ã‚‰ï¼‰
            setWhitewash('right');

            // 1ç§’ã®æº–å‚™æ™‚é–“å¾Œã«ã‚²ãƒ¼ãƒ é–‹å§‹
            setTimeout(() => {
                startRhythm();
            }, 1000);
        }

        function endGame(isWin) {
            isPlaying = false;
            if (beatInterval) clearTimeout(beatInterval);
            stopTimeBar();

            const overlay = document.getElementById('result-overlay');
            const content = document.getElementById('result-content');

            if (isWin) {
                playFanfare(); // ã‚¯ãƒªã‚¢ç”»é¢ã§ãƒ•ã‚¡ãƒ³ãƒ•ã‚¡ãƒ¼ãƒ¬

                // é›£æ˜“åº¦ã‚¢ãƒ³ãƒ­ãƒƒã‚¯å‡¦ç†
                if (currentBPM >= 160 && !unlockedGekihaya) {
                    unlockedGekihaya = true;
                    document.getElementById('btn-gekihaya').style.display = '';
                }
                if (currentBPM >= 200 && !unlockedOnihaya) {
                    unlockedOnihaya = true;
                    document.getElementById('btn-onihaya').style.display = '';
                }

                content.innerHTML = `
                <img src="${GAME_IMAGES.clear}" class="result-img">
                <div class="result-text win">ã‚¿ãƒ«ã‚¿ãƒ«ãƒã‚­ãƒ³ï¼</div>
                <div class="result-score">ã‚¿ãƒ¼ãƒ³: ${score}</div>
            `;
            } else {
                playGameOver(); // ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼éŸ³ï¼ˆAdimï¼‰
                content.innerHTML = `
                <img src="${GAME_IMAGES.gameOver}" class="result-img">
                <div class="result-text lose">Game Over</div>
                <div class="result-score">ã‚¿ãƒ¼ãƒ³: ${score}</div>
            `;
            }

            overlay.style.display = 'flex';
        }

        function goToTitle() {
            isPlaying = false;
            if (beatInterval) clearTimeout(beatInterval);
            stopTimeBar();

            // ã‚²ãƒ¼ãƒ çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
            choicesShown = false;
            pendingResult = null;
            selectedWord = null;
            gamePhase = "intro";
            currentBeat = 0;
            cycleCount = 0;
            isFirstTurn = true; // 1ã‚¿ãƒ¼ãƒ³ç›®ãƒ•ãƒ©ã‚°ã‚’ãƒªã‚»ãƒƒãƒˆ

            // UIè¦ç´ ã‚’ãƒªã‚»ãƒƒãƒˆ
            const barLeft = document.getElementById('time-bar-left');
            const barRight = document.getElementById('time-bar-right');
            barLeft.style.width = '50%';
            barRight.style.width = '50%';
            barLeft.classList.remove('warning', 'danger');
            barRight.classList.remove('warning', 'danger');

            document.getElementById('speech-left').textContent = '';
            document.getElementById('speech-right').textContent = '';
            document.getElementById('choices').innerHTML = '';
            document.getElementById('next-char').textContent = '';
            document.getElementById('judgment-mark').className = 'judgment-mark';
            document.getElementById('countdown-overlay').classList.remove('show');

            document.getElementById('game-screen').style.display = 'none';
            document.getElementById('result-overlay').style.display = 'none';
            document.getElementById('title-screen').style.display = 'flex';
        }
    </script>

</body>

</html>